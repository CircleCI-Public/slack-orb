description: |
  Add a reaction to an slack message.

parameters:
  channel:
    type: string
    description: Select which channel in which to post to. Only Channel ID is supported for now. Set the "SLACK_DEFAULT_CHANNEL" environment variable for the default channel.
    default: $SLACK_DEFAULT_CHANNEL
  add_react_name:
    default: ''
    type: string
    description: The name of the reaction you want to add, e.g. check, hourglass_flowing_sand, x, etc.
  remove_react_name:
    type: string
    default: ''
    description: The name of the reaction you previsously added, e.g. check, hourglass_flowing_sand, x, etc.
  thread_id:
    type: string
    description: The thread id where this reaction will be added.
  step_name:
    default: Add or Remove Reaction to Slack message
    description: Specify a custom step name for this command, if desired
    type: string
  debug:
    default: false
    description: Runs scripts in debug mode for bash (set -x).
    type: boolean
  event:
    description: |
      In what event should this message send? Options: ["fail", "pass", "always"]
    type: enum
    enum: ["fail", "pass", "always"]
    default: "always"
  branch_pattern:
    description: |
      A comma separated list of regex matchable branch names. Notifications will only be sent if sent from a job from these branches. Pattern must match the full string, no partial matches.
    type: string
    default: ""
  tag_pattern:
    description: |
      A comma separated list of regex matchable tag names. Notifications will only be sent if sent from a job from these branches. Pattern must match the full string, no partial matches.
    type: string
    default: ""
  invert_match:
    description: |
      Invert the branch and tag patterns.
      If set to true, notifications will only be sent if sent from a job from branches and tags that do not match the patterns.
    type: boolean
    default: false
  windows_execution:
    description: |
      When this command is going to be run on windows, set this to true.
    type: boolean
    default: false
  api_domain:
    description: |
      Domain for the Slack API. Use slack.com for regular Slack and slack-gov.com for GovSlack.
    type: string
    default: "slack.com"
steps:
  - when:
      condition:
        equal: [ false, <<parameters.windows_execution>>]
      steps:
        - run:
            when: always
            name: << parameters.step_name >>
            command: <<include(scripts/reaction.sh)>>
            environment:
              SLACK_PARAM_CHANNEL: <<parameters.channel>>
              SLACK_PARAM_ADD_REACT_NAME: <<parameters.add_react_name>>
              SLACK_PARAM_REMOVE_REACT_NAME: <<parameters.remove_react_name>>
              SLACK_PARAM_EVENT: << parameters.event >>
              SLACK_PARAM_BRANCHPATTERN: <<parameters.branch_pattern>>
              SLACK_PARAM_TAGPATTERN: <<parameters.tag_pattern>>
              SLACK_PARAM_INVERT_MATCH: <<parameters.invert_match>>
              SLACK_PARAM_THREAD: <<parameters.thread_id>>
              SLACK_PARAM_DEBUG: << parameters.debug >>
              SLACK_PARAM_API_DOMAIN: << parameters.api_domain >>
              SLACK_SCRIPT_UTILS: "<<include(scripts/utils.sh)>>"
  - when:
      condition:
        equal: [ true, <<parameters.windows_execution>>]
      steps:
        - run:
            when: always
            shell: bash -eo pipefail
            name: << parameters.step_name >>
            command: <<include(scripts/reaction.sh)>>
            environment:
              SLACK_PARAM_CHANNEL: <<parameters.channel>>
              SLACK_PARAM_ADD_REACT_NAME: <<parameters.add_react_name>>
              SLACK_PARAM_REMOVE_REACT_NAME: <<parameters.remove_react_name>>
              SLACK_PARAM_EVENT: << parameters.event >>
              SLACK_PARAM_BRANCHPATTERN: <<parameters.branch_pattern>>
              SLACK_PARAM_TAGPATTERN: <<parameters.tag_pattern>>
              SLACK_PARAM_INVERT_MATCH: <<parameters.invert_match>>
              SLACK_PARAM_THREAD: <<parameters.thread_id>>
              SLACK_PARAM_DEBUG: << parameters.debug >>
              SLACK_PARAM_API_DOMAIN: << parameters.api_domain >>
              SLACK_SCRIPT_UTILS: "<<include(scripts/utils.sh)>>"
